name: üöÄ CI/CD Pipeline - PetTrack Microservices

on:
  push:
    branches: [main]

env:
  APP_NAME: pettrack
  COMPOSE_FILE: docker-compose.yml
  TAG: latest
  COMMIT_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # ================================
    # üîπ Checkout del c√≥digo
    # ================================
    - name: Checkout code
      uses: actions/checkout@v4

    # ================================
    # üîê Login a Azure
    # ================================
    - name: Azure login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # ================================
    # üß© Crear .env y certificados
    # ================================
    - name: Create .env files and certs
      run: |
        echo "üì¶ Creando archivos .env y certificados..."

        mkdir -p \
          services/api-gateway \
          services/auth-service \
          services/pets-service \
          services/appointment-service \
          services/rewards-service \
          services/postconsult-service \
          clients/web-client \
          certs

        # üîê Variables de entorno
        echo "${{ secrets.ENV_API_GATEWAY }}" > services/api-gateway/.env
        echo "${{ secrets.ENV_AUTH_SERVICE }}" > services/auth-service/.env
        echo "${{ secrets.ENV_PETS_SERVICE }}" > services/pets-service/.env
        echo "${{ secrets.ENV_APPOINTMENT_SERVICE }}" > services/appointment-service/.env
        echo "${{ secrets.ENV_REWARDS_SERVICE }}" > services/rewards-service/.env
        echo "${{ secrets.ENV_POSTCONSULT_SERVICE }}" > services/postconsult-service/.env
        echo "${{ secrets.ENV_WEB_CLIENT }}" > clients/web-client/.env

        # =========================
        # üîê CERTIFICADOS SSL
        # =========================

        # 1) Cert ra√≠z principal Baltimore (secret en texto plano pem)
        echo "${{ secrets.AZURE_CA_CERT }}" > certs/BaltimoreCyberTrustRoot.pem

        # 2) Copiar a cada microservicio para que Dockerfile pueda hacer COPY certs/*
        for svc in api-gateway auth-service pets-service appointment-service rewards-service postconsult-service; do
          mkdir -p services/$svc/certs
          cp certs/* services/$svc/certs/
        done

        echo "‚úÖ Certificados copiados dentro de cada microservicio."

    # ================================
    # üê≥ Login a ACR
    # ================================
    - name: Docker login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    # ================================
    # üèóÔ∏è Build de im√°genes
    # ================================
    - name: Build Docker images
      run: |
        echo "üèóÔ∏è Construyendo im√°genes..."

        REGISTRY=${{ secrets.ACR_LOGIN_SERVER }}

        docker build --no-cache -t $REGISTRY/pettrack-api-gateway:${{ env.TAG }} ./services/api-gateway
        docker build --no-cache -t $REGISTRY/pettrack-auth-service:${{ env.TAG }} ./services/auth-service
        docker build --no-cache -t $REGISTRY/pettrack-pets-service:${{ env.TAG }} ./services/pets-service
        docker build --no-cache -t $REGISTRY/pettrack-appointment-service:${{ env.TAG }} ./services/appointment-service
        docker build --no-cache -t $REGISTRY/pettrack-rewards-service:${{ env.TAG }} ./services/rewards-service
        docker build --no-cache -t $REGISTRY/pettrack-postconsult-service:${{ env.TAG }} ./services/postconsult-service

        docker build --no-cache -t $REGISTRY/pettrack-web-client:${{ env.TAG }} ./clients/web-client

        echo "üè∑Ô∏è Etiquetando con SHA..."
        for svc in api-gateway auth-service pets-service appointment-service rewards-service postconsult-service web-client; do
          docker tag $REGISTRY/pettrack-$svc:${{ env.TAG }} \
                     $REGISTRY/pettrack-$svc:${{ env.COMMIT_TAG }}
        done

        echo "‚úÖ Build completado."

    # ================================
    # üì¶ Push a ACR
    # ================================
    - name: Push Docker images to ACR
      run: |
        echo "üì§ Subiendo im√°genes al ACR..."
        REGISTRY=${{ secrets.ACR_LOGIN_SERVER }}

        for svc in api-gateway auth-service pets-service appointment-service rewards-service postconsult-service web-client; do
          docker push $REGISTRY/pettrack-$svc:${{ env.TAG }}
          docker push $REGISTRY/pettrack-$svc:${{ env.COMMIT_TAG }}
        done

        echo "‚úÖ Todas las im√°genes enviadas a ACR."
