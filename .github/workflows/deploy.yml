name: üöÄ CI/CD Pipeline - PetTrack Microservices

on:
  push:
    branches: [main]

env:
  APP_NAME: pettrack
  COMPOSE_FILE: docker-compose.yml
  TAG: latest
  COMMIT_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # ================================
    # üîπ Checkout del c√≥digo fuente
    # ================================
    - name: Checkout code
      uses: actions/checkout@v4

    # ================================
    # üîê Login a Azure
    # ================================
    - name: Azure login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # ================================
    # üß© Crear archivos .env desde los secrets
    # ================================
    - name: Create .env files from secrets
      run: |
        echo "üì¶ Creando archivos .env..."
        mkdir -p services/api-gateway services/auth-service services/pets-service services/appointment-service clients/web-client certs

        echo "${{ secrets.ENV_API_GATEWAY }}" > services/api-gateway/.env
        echo "${{ secrets.ENV_AUTH_SERVICE }}" > services/auth-service/.env
        echo "${{ secrets.ENV_PETS_SERVICE }}" > services/pets-service/.env
        echo "${{ secrets.ENV_APPOINTMENT_SERVICE }}" > services/appointment-service/.env
        echo "${{ secrets.ENV_REWARDS_SERVICE }}" > services/rewards-service/.env
        echo "${{ secrets.ENV_POSTCONSULT_SERVICE }}" > services/postconsult-service/.env
        echo "${{ secrets.ENV_WEB_CLIENT }}" > clients/web-client/.env

        echo "${{ secrets.AZURE_CA_CERT }}" > certs/BaltimoreCyberTrustRoot.pem
        echo "‚úÖ Archivos .env y certificado listos."

    # ================================
    # üê≥ Login al Azure Container Registry
    # ================================
    - name: Docker login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    # ================================
    # üèóÔ∏è Build y Tag de im√°genes (sin cache)
    # ================================
    - name: Build and tag Docker images
      run: |
        echo "üèóÔ∏è Construyendo im√°genes sin cach√© y etiquetando para ACR..."

        REGISTRY=${{ secrets.ACR_LOGIN_SERVER }}

        # Microservicios backend
        docker build --no-cache -t $REGISTRY/pettrack-api-gateway:${{ env.TAG }} ./services/api-gateway
        docker build --no-cache -t $REGISTRY/pettrack-auth-service:${{ env.TAG }} ./services/auth-service
        docker build --no-cache -t $REGISTRY/pettrack-pets-service:${{ env.TAG }} ./services/pets-service
        docker build --no-cache -t $REGISTRY/pettrack-appointment-service:${{ env.TAG }} ./services/appointment-service
        docker build --no-cache -t $REGISTRY/pettrack-rewards-service:${{ env.TAG }} ./services/rewards-service
        docker build --no-cache -t $REGISTRY/pettrack-postconsult-service:${{ env.TAG }} ./services/postconsult-service

        # Cliente web
        docker build --no-cache -t $REGISTRY/pettrack-web-client:${{ env.TAG }} ./clients/web-client

        # Etiquetar tambi√©n con el commit SHA para tracking
        docker tag $REGISTRY/pettrack-api-gateway:${{ env.TAG }} $REGISTRY/pettrack-api-gateway:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-auth-service:${{ env.TAG }} $REGISTRY/pettrack-auth-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-pets-service:${{ env.TAG }} $REGISTRY/pettrack-pets-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-appointment-service:${{ env.TAG }} $REGISTRY/pettrack-appointment-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-web-client:${{ env.TAG }} $REGISTRY/pettrack-web-client:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-rewards-service:${{ env.TAG }} $REGISTRY/pettrack-rewards-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-postconsult-service:${{ env.TAG }} $REGISTRY/pettrack-postconsult-service:${{ env.COMMIT_TAG }}
        echo "‚úÖ Im√°genes construidas y etiquetadas correctamente."

    # ================================
    # üì¶ Push de im√°genes al ACR
    # ================================
    - name: Push Docker images to ACR
      run: |
        echo "üì§ Enviando im√°genes al Azure Container Registry..."
        REGISTRY=${{ secrets.ACR_LOGIN_SERVER }}

        docker push $REGISTRY/pettrack-api-gateway:${{ env.TAG }}
        docker push $REGISTRY/pettrack-auth-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-pets-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-appointment-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-rewards-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-postconsult-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-web-client:${{ env.TAG }}

        docker push $REGISTRY/pettrack-api-gateway:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-auth-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-pets-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-appointment-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-rewards-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-postconsult-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-web-client:${{ env.COMMIT_TAG }}

        echo "‚úÖ Todas las im√°genes fueron subidas correctamente al ACR."
